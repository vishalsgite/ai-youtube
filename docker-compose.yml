version: '3.8'

services:
  # Infrastructure: Database
  youtube-insight-postgres:
    image: postgres:15
    container_name: youtube-insight-postgres
    ports: ["5432:5432"]
    environment:
      - POSTGRES_DB=youtube_insight_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=Admin
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d youtube_insight_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks: [youtube-insight-network]

  # Infrastructure: Kafka & Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks: [youtube-insight-network]

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka
    depends_on: [zookeeper]
    ports: ["9092:9092"]
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [youtube-insight-network]

  # Kafka Setup: Ensures topics are created with 3 partitions before apps start
  kafka-setup:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka-setup
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - youtube-insight-network
    command: >
      bash -c "
      echo 'Waiting for Kafka...' && \
      kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic topic-submitted-events && \
      kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic video-data-processed-events && \
      kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic topic-status-updates && \
      echo 'Kafka Topics Created Successfully!'"

  # Service 1: Topic Management
  topic-management-service:
    build: { context: ./topic-management-service }
    container_name: topic-management-service
    ports: ["8080:8080"]
    depends_on:
      kafka-setup: { condition: service_completed_successfully }
      youtube-insight-postgres: { condition: service_healthy }
    environment:
      - KAFKA_HOST=kafka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_DATASOURCE_URL=jdbc:postgresql://youtube-insight-postgres:5432/youtube_insight_db
      - GROK_API_KEY=${GROK_API_KEY}
    networks: [youtube-insight-network]

  # Service 2: YouTube Processing (Updated with Cookie Volume)
  youtube-processing-service:
    build: { context: ./youtube-processing-service }
    container_name: youtube-processing-service
    ports: ["8081:8081"]
    depends_on:
      kafka-setup: { condition: service_completed_successfully }
    volumes:
      # Maps your downloaded cookies file into the container
      - ./youtube-processing-service/youtube_cookies.txt:/app/youtube_cookies.txt
    environment:
      - KAFKA_HOST=kafka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY}
      - COOKIE_PATH=/app/youtube_cookies.txt
    networks: [youtube-insight-network]

  # Service 3: AI Analysis
  ai-analysis-service:
    build: { context: ./ai-analysis-service }
    container_name: ai-analysis-service
    ports: ["8082:8082"]
    depends_on:
      kafka-setup: { condition: service_completed_successfully }
    environment:
      - KAFKA_HOST=kafka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - GROK_API_KEY=${GROK_API_KEY}
    networks: [youtube-insight-network]

networks:
  youtube-insight-network:
    driver: bridge